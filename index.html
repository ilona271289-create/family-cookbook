<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–µ–º–µ–π–Ω–∞—è –∫–Ω–∏–≥–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤</title>
  <style>
    :root{
      --bg:#f7f7fb;--surface:#ffffff;--ink:#222;--muted:#666;--brand:#635bff;--brand-2:#7a73ff;--accent:#ff7a59;
      --radius:14px;--shadow:0 10px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
    header{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff;padding:22px 18px;position:sticky;top:0;z-index:2}
    h1{margin:0;font-size:22px}
    main{max-width:980px;margin:22px auto;padding:0 14px}
    .panel{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin:16px 0}
    h2{margin:0 0 10px 0;font-size:18px}
    .hint{color:var(--accent);font-size:13px;margin-left:6px}
    textarea,input[type="text"]{width:100%;border:1px solid #e6e6ef;border-radius:12px;padding:12px 14px;font:inherit;outline:none}
    textarea{min-height:90px}
    .btn{border:0;border-radius:12px;padding:10px 14px;font:inherit;cursor:pointer}
    .btn-brand{background:var(--brand);color:#fff}
    .btn-ghost{background:#f1f1fb;color:#2b2b34}
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    /* —á–∞—Ç */
    #chat-box{border:1px solid #e6e6ef;border-radius:12px;padding:10px;min-height:160px;background:#fafafe;max-height:360px;overflow:auto}
    .msg{display:flex;margin:8px 0}
    .msg .b{padding:10px 12px;border-radius:14px;max-width:80%;white-space:pre-wrap;line-height:1.42}
    .me .b{background:#e9e7ff;color:#1f1c5e;margin-left:auto}
    .ai .b{background:#eaf7ef;color:#14361f}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .toolbar{display:flex;gap:8px;margin-top:8px;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;background:#efeff7;font-size:12px;color:#333}
    /* —Ä–µ—Ü–µ–ø—Ç—ã */
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{background:var(--surface);border:1px solid #eee;border-radius:14px;box-shadow:var(--shadow);padding:14px}
    .title-row{display:flex;gap:8px;align-items:center}
    .star{cursor:pointer;font-size:18px}
    .star.active{color:#ffbf00}
    .small{color:var(--muted);font-size:12px}
    .tag{display:inline-block;background:#f0f0ff;color:#3a38a3;border-radius:999px;padding:4px 8px;margin:2px 4px 0 0;font-size:12px}
    .actions{display:flex;gap:8px;margin-top:8px}
    .danger{background:#ffe9e7;color:#a02214}
    .ok{background:#e6fff0;color:#0a5c2b}
    /* –º–æ–¥–∞–ª–∫–∞ –∫–ª—é—á–∞ */
    #key-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:9999}
    .modal{background:#fff;padding:18px;border-radius:14px;box-shadow:var(--shadow);width:min(520px,94vw)}
    .right-float{position:fixed;right:14px;bottom:14px}
  </style>
</head>
<body>
  <header><h1>–ú–æ—è –∫—É–ª–∏–Ω–∞—Ä–Ω–∞—è –∫–Ω–∏–≥–∞</h1></header>
  <main>
    <!-- –ë–ª–æ–∫ ¬´–î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç¬ª -->
    <section class="panel">
      <h2>–î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç </h2>
      <div class="grid">
        <textarea id="raw" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –≥–æ—Ç–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç –∏–ª–∏ –ø—Ä–æ–¥–∏–∫—Ç—É–π—Ç–µ –∏–¥–µ—é‚Ä¶"></textarea>
        <div class="row">
          <input id="file-audio" type="file" accept="audio/*" />
          <button id="btn-clear" class="btn btn-ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button id="btn-to-chat" class="btn btn-brand">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç –¥–ª—è —Ä–∞–∑–º–µ—Ç–∫–∏</button>
        </div>
      </div>
    </section>

    <!-- –ß–∞—Ç —Å –ò–ò -->
    <section class="panel">
      <h2>–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç —Å –ò–ò </h2>
      <div id="chat-box"></div>
      <div class="toolbar">
        <button id="btn-mic" class="btn btn-ghost" title="–ù–∞–¥–∏–∫—Ç–æ–≤–∞—Ç—å">üé§</button>
        <textarea id="chat-input" placeholder="–°–∫–∞–∂–∏—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" style="flex:1"></textarea>
        <button id="btn-send" class="btn btn-brand">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button id="btn-build" class="btn btn-ghost right">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç</button>
      </div>
    </section>

    <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <section class="panel">
      <h2>–ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã</h2>
      <div class="row">
        <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º" />
        <select id="filter-category" class="right">
          <option value="">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
          <option>–∑–∞–≤—Ç—Ä–∞–∫</option>
          <option>—Å—É–ø</option>
          <option>–≤—Ç–æ—Ä–æ–µ</option>
          <option>—Å–∞–ª–∞—Ç</option>
          <option>–≤—ã–ø–µ—á–∫–∞</option>
          <option>–¥–µ—Å–µ—Ä—Ç</option>
          <option>—Å–æ—É—Å—ã</option>
          <option>–∑–∞–∫—É—Å–∫–∏</option>
          <option>–±–ª—é–¥–∞ –Ω–∞ –≥—Ä–∏–ª–µ</option>
          <option>–±–ª—é–¥–∞ –≤ —Ç–∞–Ω–¥—ã—Ä–µ</option>
          <option>–ø–∞—Å—Ç–∞</option>
          <option>–ø–ª–æ–≤</option>
          <option>–æ–≤–æ—â–Ω—ã–µ –±–ª—é–¥–∞</option>
          <option>—Ä—ã–±–∞ –∏ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã</option>
          <option>–¥–µ—Ç—Å–∫–æ–µ</option>
          <option>–ø–æ—Å—Ç–Ω–æ–µ</option>
        </select>
        <select id="filter-time">
          <option value="">–í—Ä–µ–º—è ‚â§</option>
          <option value="15">15 –º–∏–Ω</option>
          <option value="30">30 –º–∏–Ω</option>
          <option value="45">45 –º–∏–Ω</option>
          <option value="60">60 –º–∏–Ω</option>
        </select>
        <select id="filter-fav">
          <option value="all">–í—Å–µ</option>
          <option value="only">–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ</option>
          <option value="exclude">–ë–µ–∑ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö</option>
        </select>
      </div>
    </section>

    <!-- –ö–∞—Ç–∞–ª–æ–≥ -->
    <section class="panel">
      <h2>–ú–æ–∏ —Ä–µ—Ü–µ–ø—Ç—ã</h2>
      <div id="cards" class="cards"></div>
    </section>
  </main>

  <!-- –ö–Ω–æ–ø–∫–∞ ¬´–°–º–µ–Ω–∏—Ç—å –∫–ª—é—á¬ª -->
  <button class="btn btn-ghost right-float" onclick="changeKey()">–°–º–µ–Ω–∏—Ç—å –∫–ª—é—á</button>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∫–ª—é—á–∞ -->
  <div id="key-modal">
    <div class="modal">
      <h3 style="margin:0 0 8px">–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á OpenAI</h3>
      <p style="margin:0 0 10px;color:var(--muted)">–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ (localStorage). –ï–≥–æ –º–æ–∂–Ω–æ —Å–º–µ–Ω–∏—Ç—å –ø–æ–∑–∂–µ.</p>
      <input id="key-input" type="password" placeholder="sk-..." />
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button id="key-cancel" class="btn btn-ghost">–û—Ç–º–µ–Ω–∞</button>
        <button id="key-save" class="btn btn-brand">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // ====== –û–±—Ñ—É—Å–∫–∞—Ü–∏—è –∫–ª—é—á–∞ (–º—è–≥–∫–∞—è) ======
    const KEY_STORAGE = 'family_cookbook_key_obf_v1';
    const SALT = 'fcookbook_salt_2025'; // –Ω–µ —Å–µ–∫—Ä–µ—Ç, –ø—Ä–æ—Å—Ç–æ —Å–æ–ª—å –¥–ª—è XOR
    const toB64 = s => btoa(unescape(encodeURIComponent(s)));
    const fromB64 = s => decodeURIComponent(escape(atob(s)));
    function xorStr(a,b){
      let out='';
      for(let i=0;i<a.length;i++){ out += String.fromCharCode(a.charCodeAt(i) ^ b.charCodeAt(i % b.length)); }
      return out;
    }
    function setObfKey(plain){ localStorage.setItem(KEY_STORAGE, toB64(xorStr(plain,SALT))); }
    function getObfKey(){ const v = localStorage.getItem(KEY_STORAGE); return v? xorStr(fromB64(v),SALT):''; }
    function clearObfKey(){ localStorage.removeItem(KEY_STORAGE); }

    function showKeyModal(){
      const modal = document.getElementById('key-modal');
      document.getElementById('key-input').value='';
      modal.style.display='flex';
      document.getElementById('key-cancel').onclick = ()=> modal.style.display='none';
      document.getElementById('key-save').onclick = ()=>{
        const k = document.getElementById('key-input').value.trim();
        if(!k.startsWith('sk-')){alert('–ü–æ—Ö–æ–∂–µ, —ç—Ç–æ –Ω–µ –∫–ª—é—á OpenAI.');return;}
        setObfKey(k); modal.style.display='none'; alert('–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ú–æ–∂–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ò–ò.');
      }
    }
    function ensureKey(){ if(!getObfKey()) showKeyModal(); }
    function changeKey(){ showKeyModal(); }
    window.changeKey = changeKey;
    window.addEventListener('DOMContentLoaded', () => { ensureKey(); if (!sessionStorage.getItem('greeted')) { addMsg('assistant','–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à —à–µ—Ñ‚Äë–ø–æ–≤–∞—Ä ü§ù –ù–∞–¥–∏–∫—Ç—É–π—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ, –∞ —è –ø–æ–º–æ–≥—É —Å–æ–±—Ä–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç –∏ –ø–æ–¥—Å–∫–∞–∂—É —Ñ–∏—à–∫–∏.'); sessionStorage.setItem('greeted','1'); } });

    // ====== –ú–∏–Ω–∏‚Äë—Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –≤ localStorage ======
    const STORE = 'family_cookbook_recipes_v1';
    function load(){ try{return JSON.parse(localStorage.getItem(STORE)||'[]')}catch(e){return []} }
    function save(v){ localStorage.setItem(STORE, JSON.stringify(v)); }

    // ====== –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ ======
    function render(){
      const root=document.getElementById('cards');
      const q=document.getElementById('search').value.toLowerCase();
      const cat=document.getElementById('filter-category').value;
      const tmax=Number(document.getElementById('filter-time').value||0);
      const fav=document.getElementById('filter-fav').value;
      root.innerHTML='';
      load().filter(r=>{
        const inQ = !q || (r.title||'').toLowerCase().includes(q) || (r.ingredients_plain||'').includes(q);
        const inCat = !cat || (r.category||'')===cat;
        const inTime = !tmax || (parseInt(r.time||'0')||999) <= tmax;
        const inFav = fav==='all' || (fav==='only'&&r.fav) || (fav==='exclude'&&!r.fav);
        return inQ && inCat && inTime && inFav;
      }).forEach((r,idx)=>{
        const c=document.createElement('div');c.className='card';
        const row=document.createElement('div');row.className='title-row';
        const h=document.createElement('strong');h.textContent=r.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        const star=document.createElement('span');star.className='star'+(r.fav?' active':'');star.textContent='‚òÖ';
        star.onclick=()=>{const arr=load();arr[idx].fav=!arr[idx].fav;save(arr);render();};
        row.append(h,star);
        const p=document.createElement('div');p.className='small';p.textContent=`‚è± ${r.time||''} ‚Ä¢ üçΩ ${r.servings||''} ‚Ä¢ ${r.category||''}`;
        const ing=document.createElement('div');ing.innerHTML='<div class="small">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</div>'+(r.ingredients||'').replace(/\n/g,'<br>');
        const st=document.createElement('div');st.innerHTML='<div class="small">–®–∞–≥–∏:</div>'+(r.steps||'').replace(/\n/g,'<br>');
        const actions=document.createElement('div');actions.className='actions';
        const bEdit=document.createElement('button');bEdit.className='btn ok';bEdit.textContent='‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        bEdit.onclick=()=>editRecipe(idx);
        const bDel=document.createElement('button');bDel.className='btn danger';bDel.textContent='üóë –£–¥–∞–ª–∏—Ç—å';
        bDel.onclick=()=>{if(confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç?')){const arr=load();arr.splice(idx,1);save(arr);render();}};
        actions.append(bEdit,bDel);
        c.append(row,p,ing,st,actions);
        root.append(c);
      });
    }

    // ====== –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ======
    function editRecipe(i){
      const arr=load(); const r=arr[i];
      const t=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ', r.title||'')||r.title;
      const cat=prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—É–ø, –±–ª—é–¥–∞ –Ω–∞ –≥—Ä–∏–ª–µ‚Ä¶)', r.category||'')||r.category;
      const sv=prompt('–ü–æ—Ä—Ü–∏–∏', r.servings||'')||r.servings;
      const tm=prompt('–û–±—â–µ–µ –≤—Ä–µ–º—è (–º–∏–Ω)', r.time||'')||r.time;
      const ing=prompt('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)', r.ingredients||'')||r.ingredients;
      const st=prompt('–®–∞–≥–∏ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)', r.steps||'')||r.steps;
      arr[i] = {...r, title:t, category:cat, servings:sv, time:tm, ingredients:ing, steps:st, ingredients_plain:(ing||'').toLowerCase()};
      save(arr); render();
    }

    // ====== –ß–∞—Ç –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ü–µ–ø—Ç–∞ ======
    const messages = [
      {
        role: 'system',
        content: [
          "–¢—ã ‚Äî —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã–π –∏ –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä, –∫–æ—Ç–æ—Ä—ã–π –∫–∞–π—Ñ—É–µ—Ç –æ—Ç –¥–æ–º–∞—à–Ω–µ–π –∫—É—Ö–Ω–∏.",
          "–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: –∂–∏–≤–æ–π, –º–æ–ª–æ–¥—ë–∂–Ω—ã–π, –Ω–æ —É–º–µ—Å—Ç–Ω—ã–π; –º–æ–∂–Ω–æ –∏–Ω–æ–≥–¥–∞ –ª—ë–≥–∫–∏–µ —ç–º–æ–¥–∑–∏ –∏ —Å–ª–µ–Ω–≥, –±–µ–∑ –ø–µ—Ä–µ–±–æ—Ä–∞.",
          "–í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π –ø–æ –¥–µ–ª—É, –ø–æ–º–æ–≥–∞–π —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∂–∏–∑–Ω—å –Ω–∞ –∫—É—Ö–Ω–µ –∏ –Ω–µ —É—Å–ª–æ–∂–Ω—è–π, –µ—Å–ª–∏ –º–æ–∂–Ω–æ –ø—Ä–æ—â–µ.",
          "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞: –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã, –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏, –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤/—à–∞–≥–æ–≤, –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏.",
          "–ï–¥–∏–Ω–∏—Ü—ã: —Ç–æ–ª—å–∫–æ –º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ (–≥, –∫–≥, –º–ª, –ª, ¬∞C); –ø–æ—Ä—Ü–∏–∏ ‚Äî real-life (2‚Äì6 –ø–æ—Ä—Ü–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ).",
          "–°—Ç—Ä–∞—Ç–µ–≥–∏—è: —Å–Ω–∞—á–∞–ª–∞ —É—Ç–æ—á–Ω–∏ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ (–∞–ª–ª–µ—Ä–≥–∏–∏, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ, –≤—Ä–µ–º—è), –Ω–æ –Ω–µ –∑–∞–¥–∞–≤–∞–π —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å—Ä–∞–∑—É.",
          "–ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –≤–∞—Ä–∏–∞–Ω—Ç –±—ã—Å—Ç—Ä–µ–µ/–¥–µ—à–µ–≤–ª–µ/–ø–æ–ª–µ–∑–Ω–µ–µ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ 2‚Äì3 –æ–ø—Ü–∏–∏ —Å –ø–ª—é—Å–∞–º–∏.",
          "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Ä–µ–∞–ª–∏–∑–º: –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –æ–ø–∞—Å–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤; —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã/–≤—Ä–µ–º–µ–Ω–∞ ‚Äî –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω—ã–µ; –ø–æ–º–µ—á–∞–π, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ.",
          "–Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π.",
          "–¢–æ–Ω: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π; –∏–Ω–æ–≥–¥–∞ –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ª—ë–≥–∫–∏–π —é–º–æ—Ä, —ç–º–æ–¥–∑–∏ —Ç–∏–ø–∞ üòãüî•‚ú® —É–º–µ—Å—Ç–Ω–æ. –ò–∑–±–µ–≥–∞–π —Ç–æ–∫—Å–∏—á–Ω–æ–≥–æ, –≥—Ä—É–±–æ–≥–æ –∏–ª–∏ —Å–Ω–∏—Å—Ö–æ–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–æ–Ω–∞.",
          "–ö—Ä–∞—Ç–∫–æ—Å—Ç—å: —Ü–µ–ª—å ‚Äî 6‚Äì10 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π + —Å–ø–∏—Å–∫–∏. –ë–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã."
        ].join("
");
    messages.push({role:'user',content:ask}); addMsg('user','–°—Ñ–æ—Ä–º–∏—Ä—É–π –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç‚Ä¶');
      const data=await callOpenAIChat(messages); const txt=data.choices?.[0]?.message?.content||''; addMsg('assistant',txt);
      try{ const json=JSON.parse(txt.replace(/```json|```/g,''));
        const arr=load();
        arr.unshift({
          title:json.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', category:json.category||'', servings:json.servings||'', time:json.time||'',
          ingredients:(json.ingredients||[]).join('\n'), steps:(json.steps||[]).join('\n'), fav:false,
          ingredients_plain:(json.ingredients||[]).join(', ').toLowerCase()
        }); save(arr); render(); alert('–†–µ—Ü–µ–ø—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞—Ç–∞–ª–æ–≥.');
      }catch(e){ console.warn('–ù–µ JSON –æ—Ç –º–æ–¥–µ–ª–∏, –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é'); }
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ ¬´–≥–æ—Ç–æ–≤–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞¬ª –∏–∑ –≤–µ—Ä—Ö–Ω–µ–≥–æ –ø–æ–ª—è –≤ —á–∞—Ç
    document.getElementById('btn-to-chat').onclick=()=>{
      const v=document.getElementById('raw').value.trim(); if(!v) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–µ—Ü–µ–ø—Ç–∞ –∏–ª–∏ –∏–¥–µ–∏');
      document.getElementById('chat-input').value = '–†–∞–∑–º–µ—Ç—å –∏ –ø—Ä–∏–≤–µ–¥–∏ –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç:

' + v;
      document.getElementById('btn-send').click();
    };
    document.getElementById('btn-clear').onclick=()=>{ document.getElementById('raw').value=''; };

    // –ú–∏–∫—Ä–æ—Ñ–æ–Ω: –∑–∞–ø–∏—Å—å ‚Üí Whisper ‚Üí –≤ —á–∞—Ç
    let mediaRecorder=null, chunks=[]; let isRecording=false;
    document.getElementById('btn-mic').onclick = async () => {
      const btn = document.getElementById('btn-mic');
      if(!isRecording){
        try{
          const stream = await navigator.mediaDevices.getUserMedia({audio:true});
          chunks=[]; mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = e => { if(e.data.size) chunks.push(e.data); };
          mediaRecorder.onstop = async () => {
            const blob = new Blob(chunks,{type:'audio/webm'});
            const file = new File([blob], 'voice.webm', {type:'audio/webm'});
            addMsg('user','[–ì–æ–ª–æ—Å–æ–≤–æ–µ: —Ä–∞—Å–ø–æ–∑–Ω–∞—é‚Ä¶]');
            try {
              const tr = await transcribeAudio(file);
              const text = tr.text || '';
              if(text){ addMsg('user', text); messages.push({role:'user', content:text});
                const data = await callOpenAIChat(messages);
                const a = data.choices?.[0]?.message?.content || '';
                messages.push({role:'assistant',content:a}); addMsg('assistant',a);
              }
            } catch(e){ addMsg('assistant','[–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∞—É–¥–∏–æ]'); }
          };
          mediaRecorder.start(); isRecording=true; btn.textContent='‚ñ†'; btn.style.background='#ff4d4f'; btn.style.color='#fff'; btn.title='–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
        }catch(e){ alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É'); }
      } else {
        mediaRecorder?.stop(); isRecording=false; const btn=document.getElementById('btn-mic'); btn.textContent='üé§'; btn.style.background=''; btn.style.color=''; btn.title='–ù–∞–¥–∏–∫—Ç–æ–≤–∞—Ç—å';
      }
    };
    // –ê—É–¥–∏–æ –≤ –≤–µ—Ä—Ö–Ω–µ–π —Å–µ–∫—Ü–∏–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –≤ –ø–æ–ª–µ raw
    document.getElementById('file-audio').onchange = async (e)=>{
      const f=e.target.files?.[0]; if(!f) return; const tr=await transcribeAudio(f); document.getElementById('raw').value=(tr.text||''); e.target.value='';
    };

    // –ü–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
    document.getElementById('search').oninput=render;
    document.getElementById('filter-category').onchange=render;
    document.getElementById('filter-time').onchange=render;
    document.getElementById('filter-fav').onchange=render;
    render();
  </script>
</body>
</html>
