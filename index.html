<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è –∫–Ω–∏–≥–∞ El Pablo</title>
  <style>
    :root{
      --bg:#f0fdfa;
      --surface:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --brand:#14b8a6;
      --brand-light:#2dd4bf;
      --brand-dark:#0d9488;
      --accent:#f59e0b;
      --border:#e2e8f0;
      --shadow:0 2px 8px rgba(20,184,166,.08);
      --shadow-lg:0 8px 24px rgba(20,184,166,.15);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background:var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      color:var(--ink);
      line-height:1.6;
    }
    
    /* Header */
    header{
      background:linear-gradient(135deg,var(--brand),var(--brand-light));
      color:#fff;
      padding:1.25rem 1rem;
      position:sticky;
      top:0;
      z-index:100;
      box-shadow:var(--shadow-lg);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    h1{
      font-size:1.5rem;
      font-weight:700;
      letter-spacing:-0.02em;
    }
    .user-info{
      display:flex;
      align-items:center;
      gap:0.75rem;
      font-size:0.9rem;
    }
    .user-avatar{
      width:36px;
      height:36px;
      border-radius:50%;
      border:2px solid rgba(255,255,255,.3);
    }
    .btn-signout{
      background:rgba(255,255,255,.2);
      border:none;
      color:#fff;
      padding:0.5rem 1rem;
      border-radius:8px;
      cursor:pointer;
      font-size:0.875rem;
      transition:background 0.2s;
    }
    .btn-signout:hover{
      background:rgba(255,255,255,.3);
    }
    
    /* Main */
    main{
      max-width:1200px;
      margin:0 auto;
      padding:1.5rem 1rem;
    }
    
    /* Auth Screen */
    .auth-screen{
      position:fixed;
      inset:0;
      background:linear-gradient(135deg,var(--brand),var(--brand-light));
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .auth-box{
      background:#fff;
      padding:3rem;
      border-radius:16px;
      box-shadow:var(--shadow-lg);
      text-align:center;
      max-width:400px;
      width:90%;
    }
    .auth-box h2{
      color:var(--brand);
      margin-bottom:1rem;
      font-size:1.75rem;
    }
    .auth-box p{
      color:var(--muted);
      margin-bottom:2rem;
    }
    .btn-google{
      background:#fff;
      border:2px solid var(--border);
      padding:0.875rem 2rem;
      border-radius:8px;
      font-size:1rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:0.75rem;
      transition:all 0.2s;
      font-weight:500;
    }
    .btn-google:hover{
      border-color:var(--brand);
      box-shadow:var(--shadow);
    }
    
    /* Panel */
    .panel{
      background:var(--surface);
      border-radius:12px;
      box-shadow:var(--shadow);
      padding:1.5rem;
      margin-bottom:1.5rem;
    }
    h2{
      font-size:1.25rem;
      font-weight:600;
      margin-bottom:1rem;
      color:var(--brand);
    }
    
    /* Form Elements */
    textarea,input[type="text"],input[type="password"],select{
      width:100%;
      border:1px solid var(--border);
      border-radius:8px;
      padding:0.75rem;
      font:inherit;
      outline:none;
      transition:border-color 0.2s;
      background:var(--surface);
    }
    textarea:focus,input:focus,select:focus{
      border-color:var(--brand);
    }
    textarea{
      min-height:80px;
      resize:vertical;
    }
    
    /* Buttons */
    .btn{
      border:none;
      border-radius:8px;
      padding:0.75rem 1.25rem;
      font:inherit;
      font-weight:500;
      cursor:pointer;
      transition:all 0.2s;
      display:inline-flex;
      align-items:center;
      gap:0.5rem;
    }
    .btn-brand{
      background:var(--brand);
      color:#fff;
    }
    .btn-brand:hover{
      background:var(--brand-dark);
      transform:translateY(-1px);
    }
    .btn-ghost{
      background:var(--bg);
      color:var(--ink);
    }
    .btn-ghost:hover{
      background:#e0f2fe;
    }
    .btn-sm{
      padding:0.5rem 0.875rem;
      font-size:0.875rem;
    }
    
    /* Grid & Layout */
    .grid{display:grid;gap:1rem}
    .row{
      display:flex;
      gap:0.75rem;
      align-items:center;
      flex-wrap:wrap;
    }
    
    /* Chat */
    #chat-box{
      border:1px solid var(--border);
      border-radius:8px;
      padding:1rem;
      min-height:200px;
      max-height:400px;
      background:#fefefe;
      overflow-y:auto;
      margin-bottom:1rem;
    }
    .msg{
      display:flex;
      margin:0.75rem 0;
      animation:fadeIn 0.3s;
    }
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }
    .msg .b{
      padding:0.75rem 1rem;
      border-radius:12px;
      max-width:85%;
      white-space:pre-wrap;
      line-height:1.5;
      word-wrap:break-word;
    }
    .me{justify-content:flex-end}
    .me .b{
      background:var(--brand);
      color:#fff;
    }
    .ai .b{
      background:#f1f5f9;
      color:var(--ink);
    }
    
    /* Chat Input Area */
    .chat-input-area{
      display:grid;
      gap:0.75rem;
    }
    .chat-controls{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:0.75rem;
      align-items:end;
    }
    #chat-input{
      min-height:60px;
      resize:none;
    }
    
    /* Cards */
    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:1.25rem;
    }
    .card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:var(--shadow);
      padding:1.25rem;
      transition:all 0.2s;
    }
    .card:hover{
      box-shadow:var(--shadow-lg);
      transform:translateY(-2px);
    }
    .title-row{
      display:flex;
      gap:0.75rem;
      align-items:start;
      margin-bottom:0.75rem;
    }
    .card-title{
      flex:1;
      font-weight:600;
      font-size:1.1rem;
      line-height:1.3;
    }
    .star{
      cursor:pointer;
      font-size:1.5rem;
      line-height:1;
      transition:transform 0.2s;
      color:#ddd;
    }
    .star:hover{transform:scale(1.2)}
    .star.active{color:#f59e0b}
    .card-meta{
      color:var(--muted);
      font-size:0.875rem;
      margin-bottom:0.75rem;
      display:flex;
      flex-wrap:wrap;
      gap:0.5rem;
    }
    .card-section{
      margin-top:1rem;
      padding-top:1rem;
      border-top:1px solid var(--border);
    }
    .card-section-title{
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:var(--muted);
      margin-bottom:0.5rem;
      font-weight:600;
    }
    .card-content{
      font-size:0.9rem;
      line-height:1.6;
    }
    .actions{
      display:flex;
      gap:0.5rem;
      margin-top:1rem;
    }
    .danger{background:#fee2e2;color:#dc2626}
    .danger:hover{background:#fecaca}
    .success{background:#d1fae5;color:#059669}
    .success:hover{background:#a7f3d0}
    
    /* Filters */
    .filters{
      display:grid;
      grid-template-columns:2fr 1fr 1fr 1fr;
      gap:0.75rem;
    }
    
    /* Modal */
    #key-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.5);
      z-index:1000;
      padding:1rem;
    }
    .modal{
      background:#fff;
      padding:2rem;
      border-radius:12px;
      box-shadow:var(--shadow-lg);
      width:100%;
      max-width:500px;
    }
    .modal h3{
      margin-bottom:0.5rem;
      color:var(--brand);
    }
    .modal p{
      color:var(--muted);
      font-size:0.9rem;
      margin-bottom:1rem;
    }
    
    /* Float Button */
    .float-btn{
      position:fixed;
      right:1rem;
      bottom:1rem;
      z-index:50;
      box-shadow:var(--shadow-lg);
    }
    
    /* Sync Status */
    .sync-status{
      display:inline-flex;
      align-items:center;
      gap:0.5rem;
      font-size:0.875rem;
      color:rgba(255,255,255,.9);
    }
    .sync-indicator{
      width:8px;
      height:8px;
      border-radius:50%;
      background:#10b981;
      animation:pulse 2s infinite;
    }
    @keyframes pulse{
      0%,100%{opacity:1}
      50%{opacity:0.5}
    }
    
    /* Mobile Responsive */
    @media(max-width:768px){
      h1{font-size:1.25rem}
      h2{font-size:1.1rem}
      main{padding:1rem 0.75rem}
      .panel{padding:1rem;margin-bottom:1rem}
      .filters{grid-template-columns:1fr}
      .cards{grid-template-columns:1fr}
      .chat-controls{grid-template-columns:1fr}
      .chat-controls .btn{width:100%;justify-content:center}
      #btn-build{order:3}
      .row{flex-direction:column;align-items:stretch}
      .btn{width:100%;justify-content:center}
      .msg .b{max-width:90%}
      .float-btn{right:0.75rem;bottom:0.75rem;font-size:0.875rem;padding:0.625rem 1rem}
      header{flex-direction:column;gap:0.5rem;align-items:flex-start}
      .user-info{font-size:0.8rem}
      .user-avatar{width:32px;height:32px}
    }
    
    /* Empty State */
    .empty-state{
      text-align:center;
      padding:3rem 1rem;
      color:var(--muted);
    }
    
    /* Loading */
    .loading{
      text-align:center;
      padding:2rem;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div id="auth-screen" class="auth-screen" style="display:none">
    <div class="auth-box">
      <div style="font-size:4rem;margin-bottom:1rem">üç≥</div>
      <h2>–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è –∫–Ω–∏–≥–∞ El Pablo</h2>
      <p>–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ–º–µ–π–Ω—ã–º —Ä–µ—Ü–µ–ø—Ç–∞–º</p>
      <button id="btn-signin" class="btn-google">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.17.282-1.709V4.958H.957C.347 6.173 0 7.548 0 9c0 1.452.348 2.827.957 4.042l3.007-2.335z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg>
        –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
      </button>
    </div>
  </div>

  <header>
    <h1>üç≥ –ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è –∫–Ω–∏–≥–∞ El Pablo</h1>
    <div class="user-info" id="user-info" style="display:none">
      <div class="sync-status">
        <div class="sync-indicator"></div>
        –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
      </div>
      <img id="user-avatar" class="user-avatar" src="" alt="" />
      <button id="btn-signout" class="btn-signout">–í—ã–π—Ç–∏</button>
    </div>
  </header>
  
  <main id="main-content" style="display:none">
    <!-- AI Chat -->
    <section class="panel">
      <h2>üí¨ –°–æ–∑–¥–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç —Å –ò–ò</h2>
      <div id="chat-box"></div>
      <div class="chat-input-area">
        <div class="chat-controls">
          <button id="btn-mic" class="btn btn-ghost" title="–ù–∞–¥–∏–∫—Ç–æ–≤–∞—Ç—å">üé§</button>
          <textarea id="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∏–ª–∏ –Ω–∞–¥–∏–∫—Ç—É–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶"></textarea>
          <button id="btn-send" class="btn btn-brand">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <button id="btn-build" class="btn btn-brand">‚ú® –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç</button>
      </div>
    </section>

    <!-- Search & Filters -->
    <section class="panel">
      <h2>üîç –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã</h2>
      <div class="filters">
        <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º" />
        <select id="filter-category">
          <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
          <option>–∑–∞–≤—Ç—Ä–∞–∫</option>
          <option>—Å—É–ø</option>
          <option>–≤—Ç–æ—Ä–æ–µ</option>
          <option>—Å–∞–ª–∞—Ç</option>
          <option>–≤—ã–ø–µ—á–∫–∞</option>
          <option>–¥–µ—Å–µ—Ä—Ç</option>
          <option>—Å–æ—É—Å—ã</option>
          <option>–∑–∞–∫—É—Å–∫–∏</option>
          <option>–±–ª—é–¥–∞ –Ω–∞ –≥—Ä–∏–ª–µ</option>
          <option>–±–ª—é–¥–∞ –≤ —Ç–∞–Ω–¥—ã—Ä–µ</option>
          <option>–ø–∞—Å—Ç–∞</option>
          <option>–ø–ª–æ–≤</option>
          <option>–æ–≤–æ—â–Ω—ã–µ –±–ª—é–¥–∞</option>
          <option>—Ä—ã–±–∞ –∏ –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã</option>
          <option>–¥–µ—Ç—Å–∫–æ–µ</option>
          <option>–ø–æ—Å—Ç–Ω–æ–µ</option>
          <option>–Ω–∞–ø–∏—Ç–∫–∏</option>
        </select>
        <select id="filter-time">
          <option value="">–í—Ä–µ–º—è ‚â§</option>
          <option value="15">15 –º–∏–Ω</option>
          <option value="30">30 –º–∏–Ω</option>
          <option value="45">45 –º–∏–Ω</option>
          <option value="60">60 –º–∏–Ω</option>
        </select>
        <select id="filter-fav">
          <option value="all">–í—Å–µ</option>
          <option value="only">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ</option>
          <option value="exclude">–ë–µ–∑ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö</option>
        </select>
      </div>
    </section>

    <!-- Catalog -->
    <section class="panel">
      <h2>üìö –ù–∞—à–∏ —Ä–µ—Ü–µ–ø—Ç—ã</h2>
      <div id="cards" class="cards">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤...</div>
      </div>
    </section>
  </main>

  <!-- Change Key Button -->
  <button class="btn btn-ghost float-btn" onclick="changeKey()" style="display:none" id="key-btn">üîë –°–º–µ–Ω–∏—Ç—å –∫–ª—é—á</button>

  <!-- Key Modal -->
  <div id="key-modal">
    <div class="modal">
      <h3>–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á OpenAI</h3>
      <p>–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ (localStorage). –ï–≥–æ –º–æ–∂–Ω–æ —Å–º–µ–Ω–∏—Ç—å –ø–æ–∑–∂–µ.</p>
      <input id="key-input" type="password" placeholder="sk-..." />
      <div class="row" style="justify-content:flex-end;margin-top:1rem">
        <button id="key-cancel" class="btn btn-ghost">–û—Ç–º–µ–Ω–∞</button>
        <button id="key-save" class="btn btn-brand">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // ====== FIREBASE CONFIG ======
    const firebaseConfig = {
      apiKey: "AIzaSyAfl4HQ02HuVg_1XVDqfLKSq3urVAp2n14",
      authDomain: "el-pablo-cookbook.firebaseapp.com",
      databaseURL: "https://el-pablo-cookbook-default-rtdb.europe-west1.firebasedatabase.app", // –ó–ê–ú–ï–ù–ò –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è Realtime Database!
      projectId: "el-pablo-cookbook",
      storageBucket: "el-pablo-cookbook.firebasestorage.app",
      messagingSenderId: "59503956225",
      appId: "1:59503956225:web:bf1c8d082b8c8528918b00"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    let currentUser = null;

    // ====== AUTH ======
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('key-btn').style.display = 'block';
        document.getElementById('user-info').style.display = 'flex';
        document.getElementById('user-avatar').src = user.photoURL || '';
        ensureKey();
        listenToRecipes();
        if (!sessionStorage.getItem('greeted')) { 
          addMsg('assistant','–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à —à–µ—Ñ-–ø–æ–≤–∞—Ä ü§ñ –ù–∞–¥–∏–∫—Ç—É–π—Ç–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ, –∞ —è –ø–æ–º–æ–≥—É —Å–æ–±—Ä–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç –∏ –ø–æ–¥—Å–∫–∞–∂—É —Ñ–∏—à–∫–∏.'); 
          sessionStorage.setItem('greeted','1'); 
        }
      } else {
        currentUser = null;
        document.getElementById('auth-screen').style.display = 'flex';
        document.getElementById('main-content').style.display = 'none';
        document.getElementById('key-btn').style.display = 'none';
        document.getElementById('user-info').style.display = 'none';
      }
    });

    document.getElementById('btn-signin').onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + err.message));
    };

    document.getElementById('btn-signout').onclick = () => {
      auth.signOut();
    };

    // ====== RECIPES DATABASE ======
    let recipesCache = [];

    function listenToRecipes() {
      const recipesRef = database.ref('recipes');
      recipesRef.on('value', snapshot => {
        recipesCache = [];
        snapshot.forEach(child => {
          recipesCache.push({ id: child.key, ...child.val() });
        });
        render();
      });
    }

    function addRecipe(recipe) {
      const recipesRef = database.ref('recipes');
      recipesRef.push({
        ...recipe,
        createdBy: currentUser.uid,
        createdAt: Date.now()
      });
    }

    function updateRecipe(id, updates) {
      database.ref('recipes/' + id).update(updates);
    }

    function deleteRecipe(id) {
      database.ref('recipes/' + id).remove();
    }

    function toggleFavorite(id, currentFav) {
      const favRef = database.ref(`recipes/${id}/favorites/${currentUser.uid}`);
      if (currentFav) {
        favRef.remove();
      } else {
        favRef.set(true);
      }
    }

    // ====== RENDER ======
    function render() {
      const root = document.getElementById('cards');
      const q = (document.getElementById('search').value || '').toLowerCase();
      const cat = document.getElementById('filter-category').value;
      const tmax = Number(document.getElementById('filter-time').value || 0);
      const fav = document.getElementById('filter-fav').value;
      root.innerHTML = '';
      
      const filtered = recipesCache.filter(r => {
        const inQ = !q || (r.title || '').toLowerCase().includes(q) || (r.ingredients_plain || '').includes(q);
        const inCat = !cat || (r.category || '') === cat;
        const inTime = !tmax || (parseInt(r.time || '0') || 999) <= tmax;
        const isFav = r.favorites && r.favorites[currentUser.uid];
        const inFav = fav === 'all' || (fav === 'only' && isFav) || (fav === 'exclude' && !isFav);
        return inQ && inCat && inTime && inFav;
      });
      
      if (filtered.length === 0) {
        root.innerHTML = '<div class="empty-state"><div style="font-size:3rem;margin-bottom:1rem">üçΩÔ∏è</div><p>–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ü–µ–ø—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</p></div>';
        return;
      }
      
      filtered.forEach(r => {
        const c = document.createElement('div');
        c.className = 'card';
        
        const row = document.createElement('div');
        row.className = 'title-row';
        const h = document.createElement('div');
        h.className = 'card-title';
        h.textContent = r.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        const star = document.createElement('span');
        const isFav = r.favorites && r.favorites[currentUser.uid];
        star.className = 'star' + (isFav ? ' active' : '');
        star.textContent = '‚òÖ';
        star.onclick = () => toggleFavorite(r.id, isFav);
        row.append(h, star);
        
        const meta = document.createElement('div');
        meta.className = 'card-meta';
        meta.innerHTML = `<span>‚è± ${r.time || '‚Äî'}</span><span>üçΩ ${r.servings || '‚Äî'}</span><span>${r.category || '‚Äî'}</span>`;
        
        const ing = document.createElement('div');
        ing.className = 'card-section';
        ing.innerHTML = '<div class="card-section-title">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</div><div class="card-content">' + (r.ingredients || '').replace(/\n/g, '<br>') + '</div>';
        
        const st = document.createElement('div');
        st.className = 'card-section';
        st.innerHTML = '<div class="card-section-title">–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ</div><div class="card-content">' + (r.steps || '').replace(/\n/g, '<br>') + '</div>';
        
        const actions = document.createElement('div');
        actions.className = 'actions';
        const bEdit = document.createElement('button');
        bEdit.className = 'btn btn-sm success';
        bEdit.textContent = '‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        bEdit.onclick = () => editRecipe(r);
        const bDel = document.createElement('button');
        bDel.className = 'btn btn-sm danger';
        bDel.textContent = 'üóë –£–¥–∞–ª–∏—Ç—å';
        bDel.onclick = () => {
          if (confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç?')) deleteRecipe(r.id);
        };
        actions.append(bEdit, bDel);
        
        c.append(row, meta, ing, st, actions);
        root.append(c);
      });
    }

    function editRecipe(r) {
      const t = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ', r.title || '') || r.title;
      const cat = prompt('–ö–∞—Ç–µ–≥–æ—Ä–∏—è', r.category || '') || r.category;
      const sv = prompt('–ü–æ—Ä—Ü–∏–∏', r.servings || '') || r.servings;
      const tm = prompt('–û–±—â–µ–µ –≤—Ä–µ–º—è (–º–∏–Ω)', r.time || '') || r.time;
      const ing = prompt('–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)', r.ingredients || '') || r.ingredients;
      const st = prompt('–®–∞–≥–∏ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)', r.steps || '') || r.steps;
      updateRecipe(r.id, {
        title: t,
        category: cat,
        servings: sv,
        time: tm,
        ingredients: ing,
        steps: st,
        ingredients_plain: (ing || '').toLowerCase()
      });
    }

    // ====== OPENAI KEY ======
    const KEY_STORAGE = 'family_cookbook_key_obf_v1';
    const SALT = 'fcookbook_salt_2025';
    const toB64 = s => btoa(unescape(encodeURIComponent(s)));
    const fromB64 = s => decodeURIComponent(escape(atob(s)));
    function xorStr(a,b){ let out=''; for(let i=0;i<a.length;i++){ out += String.fromCharCode(a.charCodeAt(i) ^ b.charCodeAt(i % b.length)); } return out; }
    function setObfKey(plain){ localStorage.setItem(KEY_STORAGE, toB64(xorStr(plain,SALT))); }
    function getObfKey(){ const v = localStorage.getItem(KEY_STORAGE); return v? xorStr(fromB64(v),SALT):''; }
    function clearObfKey(){ localStorage.removeItem(KEY_STORAGE); }

    function showKeyModal(){
      const modal = document.getElementById('key-modal');
      document.getElementById('key-input').value='';
      modal.style.display='flex';
      document.getElementById('key-cancel').onclick = ()=> modal.style.display='none';
      document.getElementById('key-save').onclick = ()=>{
        const k = document.getElementById('key-input').value.trim();
        if(!k.startsWith('sk-')){alert('–ü–æ—Ö–æ–∂–µ, —ç—Ç–æ –Ω–µ –∫–ª—é—á OpenAI.');return;}
        setObfKey(k); modal.style.display='none'; alert('–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ú–æ–∂–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ò–ò.');
      }
    }
    function ensureKey(){ if(!getObfKey()) showKeyModal(); }
    function changeKey(){ showKeyModal(); }
    window.changeKey = changeKey;

    // ====== CHAT ======
    function addMsg(role,text){
      const box=document.getElementById('chat-box');
      const wrap=document.createElement('div');wrap.className='msg '+(role==='user'?'me':'ai');
      const b=document.createElement('div');b.className='b';b.innerText=text;wrap.append(b);box.append(wrap);box.scrollTop=box.scrollHeight;
    }

    async function callOpenAIChat(messages){
      const key=getObfKey(); if(!key){ ensureKey(); throw new Error('–ù–µ—Ç –∫–ª—é—á–∞'); }
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
      const proxyUrl = 'https://corsproxy.io/?';
      const apiUrl = 'https://api.openai.com/v1/chat/completions';
      
      const resp=await fetch(proxyUrl + encodeURIComponent(apiUrl),{ 
        method:'POST', 
        headers:{
          'Authorization':`Bearer ${key}`,
          'Content-Type':'application/json'
        }, 
        body:JSON.stringify({model:'gpt-3.5-turbo',messages,temperature:0.2}) 
      });
      
      if(!resp.ok){ 
        const errorData = await resp.json().catch(() => ({}));
        console.error('OpenAI API Error:', resp.status, errorData);
        if(resp.status===401){ clearObfKey(); ensureKey(); } 
        throw new Error(`OpenAI error ${resp.status}: ${errorData.error?.message || 'Unknown error'}`); 
      }
      return await resp.json();
    }

    async function transcribeAudio(file){
      const key=getObfKey(); if(!key){ ensureKey(); throw new Error('–ù–µ—Ç –∫–ª—é—á–∞'); }
      
      const fd=new FormData(); 
      fd.append('file',file); 
      fd.append('model','whisper-1');
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
      const proxyUrl = 'https://corsproxy.io/?';
      const apiUrl = 'https://api.openai.com/v1/audio/transcriptions';
      
      const resp=await fetch(proxyUrl + encodeURIComponent(apiUrl),{ 
        method:'POST', 
        headers:{
          'Authorization':`Bearer ${key}`
        }, 
        body:fd 
      });
      
      if(!resp.ok){ 
        const errorData = await resp.json().catch(() => ({}));
        console.error('Whisper API Error:', resp.status, errorData);
        if(resp.status===401){ clearObfKey(); ensureKey(); } 
        throw new Error(`Whisper error ${resp.status}: ${errorData.error?.message || 'Unknown error'}`); 
      }
      return await resp.json();
    }

    const messages=[{role:'system',content:[
      '–¢—ã ‚Äî —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤—ã–π —à–µ—Ñ-–ø–æ–≤–∞—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç —Ä–µ—Ü–µ–ø—Ç—ã –¥–ª—è –ù–û–í–ò–ß–ö–û–í –Ω–∞ –∫—É—Ö–Ω–µ.',
      '',
      'üéØ –ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û: –í –∫–∞–∂–¥–æ–º —à–∞–≥–µ —Ä–µ—Ü–µ–ø—Ç–∞ —É–∫–∞–∑—ã–≤–∞–π –¢–û–ß–ù–´–ï –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.',
      '',
      '–ü–†–ê–í–ò–õ–¨–ù–û: "–í–∑–±–µ–π 3 —è–π—Ü–∞ —Å–æ 180 –≥ —Å–∞—Ö–∞—Ä–∞ –∏ 2 –≥ –≤–∞–Ω–∏–ª—å–Ω–æ–≥–æ —Å–∞—Ö–∞—Ä–∞ –¥–æ –ø—ã—à–Ω–æ—Å—Ç–∏."',
      '–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–í–∑–±–µ–π —è–π—Ü–∞ —Å —Å–∞—Ö–∞—Ä–æ–º –∏ –≤–∞–Ω–∏–ª—å–Ω—ã–º —Å–∞—Ö–∞—Ä–æ–º –¥–æ –ø—ã—à–Ω–æ—Å—Ç–∏."',
      '',
      '–ü–†–ê–í–ò–õ–¨–ù–û: "–î–æ–±–∞–≤—å 200 –º–ª –º–æ–ª–æ–∫–∞ –∏ 50 –≥ —Ä–∞—Å—Ç–æ–ø–ª–µ–Ω–Ω–æ–≥–æ —Å–ª–∏–≤–æ—á–Ω–æ–≥–æ –º–∞—Å–ª–∞."',
      '–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–î–æ–±–∞–≤—å –º–æ–ª–æ–∫–æ –∏ –º–∞—Å–ª–æ."',
      '',
      'üìù –§–æ—Ä–º–∞—Ç —Ä–µ—Ü–µ–ø—Ç–∞:',
      '- –ö–∞–∂–¥—ã–π —à–∞–≥ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞–º–∏',
      '- –£–∫–∞–∑—ã–≤–∞–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –¥—É—Ö–æ–≤–∫–∏, –≤—Ä–µ–º—è –≥–æ—Ç–æ–≤–∫–∏, —Ä–∞–∑–º–µ—Ä —Ñ–æ—Ä–º—ã',
      '- –û–ø–∏—Å—ã–≤–∞–π –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ü–∏—é ("–¥–æ –≥—É—Å—Ç–æ—Ç—ã —Å–º–µ—Ç–∞–Ω—ã", "–¥–æ –∑–æ–ª–æ—Ç–∏—Å—Ç–æ–π –∫–æ—Ä–æ—á–∫–∏")',
      '- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–π –æ –≤–∞–∂–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–∞—Ö ("–Ω–µ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–π —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ", "—Å–ª–µ–¥–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ–¥–≥–æ—Ä–µ–ª–æ")',
      '',
      'üé® –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:',
      '- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ —á—ë—Ç–∫–∏–π',
      '- –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è',
      '- –ú–æ–∂–Ω–æ –ª—ë–≥–∫–∏–µ —Å–º–∞–π–ª—ã üòãüî•',
      '',
      'üìè –ï–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è:',
      '- –¢–æ–ª—å–∫–æ –º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ (–≥, –∫–≥, –º–ª, –ª, ¬∞C)',
      '- –ü–æ—Ä—Ü–∏–∏: 2‚Äî6 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é',
      '- –í—Ä–µ–º—è: –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω–æ (–Ω–µ "–æ–∫–æ–ª–æ", –∞ "25-30 –º–∏–Ω—É—Ç")',
      '',
      'üí° –°—Ç—Ä–∞—Ç–µ–≥–∏—è:',
      '- –°–Ω–∞—á–∞–ª–∞ —É—Ç–æ—á–Ω–∏ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ (–∞–ª–ª–µ—Ä–≥–∏–∏, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ)',
      '- –ü—Ä–µ–¥–ª–∞–≥–∞–π –≤–∞—Ä–∏–∞–Ω—Ç—ã (–±—ã—Å—Ç—Ä–µ–µ/–¥–µ—à–µ–≤–ª–µ/–ø–æ–ª–µ–∑–Ω–µ–µ)',
      '- –û–±—ä—è—Å–Ω—è–π "–ø–æ—á–µ–º—É" (–ø–æ—á–µ–º—É –Ω—É–∂–Ω–æ –æ—Ö–ª–∞–¥–∏—Ç—å —Ç–µ—Å—Ç–æ, –∑–∞—á–µ–º –ø—Ä–æ—Å–µ–∏–≤–∞—Ç—å –º—É–∫—É)',
      '',
      '–Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π',
      '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –≥–æ—Ç–æ–≤–∫–∏'
    ].join('\n')}];

    document.getElementById('btn-send').onclick=async()=>{
      const t=(document.getElementById('chat-input').value||'').trim(); if(!t) return;
      document.getElementById('chat-input').value=''; addMsg('user',t); messages.push({role:'user',content:t});
      try{
        const data=await callOpenAIChat(messages); 
        const a=data.choices?.[0]?.message?.content||''; 
        messages.push({role:'assistant',content:a}); 
        addMsg('assistant',a);
      }catch(e){
        addMsg('assistant','‚ùå –û—à–∏–±–∫–∞: '+e.message);
      }
    };

  document.getElementById('btn-build').onclick=async()=>{
    const ask=[
      '–°–æ–±–µ—Ä–∏ –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç –ø–æ –Ω–∞—à–µ–π –ø–µ—Ä–µ–ø–∏—Å–∫–µ.',
      '–í–ê–ñ–ù–û: –í –º–∞—Å—Å–∏–≤–µ steps –∫–∞–∂–¥—ã–π —à–∞–≥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¢–û–ß–ù–´–ï –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤.',
      '–ù–∞–ø—Ä–∏–º–µ—Ä: "–í–∑–±–µ–π 3 —è–π—Ü–∞ —Å–æ 180 –≥ —Å–∞—Ö–∞—Ä–∞ –¥–æ –ø—ã—à–Ω–æ—Å—Ç–∏" –≤–º–µ—Å—Ç–æ "–í–∑–±–µ–π —è–π—Ü–∞ —Å —Å–∞—Ö–∞—Ä–æ–º".',
      '',
      '–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON (–±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π) —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:',
      '{',
      '  "title": "–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞",',
      '  "category": "–∫–∞—Ç–µ–≥–æ—Ä–∏—è",',
      '  "servings": 4,',
      '  "time": "45 –º–∏–Ω",',
      '  "ingredients": ["3 —è–π—Ü–∞", "180 –≥ —Å–∞—Ö–∞—Ä–∞"],',
      '  "steps": ["–í–∑–±–µ–π 3 —è–π—Ü–∞ —Å–æ 180 –≥ —Å–∞—Ö–∞—Ä–∞ –¥–æ –ø—ã—à–Ω–æ—Å—Ç–∏."],',
      '  "notes": "–°–æ–≤–µ—Ç—ã",',
      '  "tags": ["—Ç–µ–≥1"]',
      '}'
    ].join('\n');
    
    messages.push({role:'user',content:ask}); 
    addMsg('user','–§–æ—Ä–º–∏—Ä—É—é —Ä–µ—Ü–µ–ø—Ç‚Ä¶');
    
    try{
      const data=await callOpenAIChat(messages); 
      const txt=data.choices?.[0]?.message?.content||''; 
      
      // –ü–∞—Ä—Å–∏–º JSON –±–µ–∑ –ø–æ–∫–∞–∑–∞ –≤ —á–∞—Ç–µ
      const json=JSON.parse(txt.replace(/```json|```/g,''));
      
      addRecipe({
        title:json.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', 
        category:json.category||'', 
        servings:json.servings||'', 
        time:json.time||'', 
        ingredients:(json.ingredients||[]).join('\n'), 
        steps:(json.steps||[]).join('\n'), 
        ingredients_plain:(json.ingredients||[]).join(', ').toLowerCase()
      });
      
      addMsg('assistant','‚úÖ –†–µ—Ü–µ–ø—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞—Ç–∞–ª–æ–≥!');
      alert('‚úÖ –†–µ—Ü–µ–ø—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–∞—Ç–∞–ª–æ–≥ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω!');
      
    }catch(e){ 
      console.warn('–û—à–∏–±–∫–∞:', e);
      addMsg('assistant','‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.');
    }
  };

    document.getElementById('btn-to-chat').onclick=()=>{
      const v=(document.getElementById('raw').value||'').trim(); 
      if(!v) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–µ—Ü–µ–ø—Ç–∞ –∏–ª–∏ –∏–¥–µ–∏');
      document.getElementById('chat-input').value='–†–∞–∑–º–µ—Ç—å –∏ –ø—Ä–∏–≤–µ–¥–∏ –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç:\n\n'+v;
      document.getElementById('btn-send').click();
    };

    document.getElementById('btn-clear').onclick=()=>{
      document.getElementById('raw').value='';
    };

    // ====== VOICE ======
    let mediaRecorder=null, chunks=[]; let isRecording=false;
    document.getElementById('btn-mic').onclick = async () => {
      const btn=document.getElementById('btn-mic');
      if(!isRecording){
        try{
          const stream=await navigator.mediaDevices.getUserMedia({audio:true});
          chunks=[]; 
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π MIME —Ç–∏–ø –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
          let mimeType = 'audio/webm';
          if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
            mimeType = 'audio/webm;codecs=opus';
          } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
            mimeType = 'audio/mp4';
          } else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {
            mimeType = 'audio/ogg;codecs=opus';
          } else if (MediaRecorder.isTypeSupported('audio/wav')) {
            mimeType = 'audio/wav';
          }
          
          mediaRecorder=new MediaRecorder(stream, { mimeType });
          console.log('Recording with MIME type:', mimeType);
          
          mediaRecorder.ondataavailable=e=>{ if(e.data.size) chunks.push(e.data); };
          mediaRecorder.onstop=async()=>{
            stream.getTracks().forEach(track => track.stop()); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
            
            const blob=new Blob(chunks,{type:mimeType});
            console.log('Audio blob size:', blob.size, 'type:', blob.type);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–æ MIME —Ç–∏–ø—É
            let extension = 'webm';
            if (mimeType.includes('mp4')) extension = 'mp4';
            else if (mimeType.includes('ogg')) extension = 'ogg';
            else if (mimeType.includes('wav')) extension = 'wav';
            
            const file=new File([blob],`voice.${extension}`,{type:mimeType});
            addMsg('user','[–ì–æ–ª–æ—Å–æ–≤–æ–µ: —Ä–∞—Å–ø–æ–∑–Ω–∞—é‚Ä¶]');
            try{ 
              const tr=await transcribeAudio(file); 
              const text=tr.text||''; 
              console.log('Transcribed text:', text);
              if(text){ 
                addMsg('user',text); 
                messages.push({role:'user',content:text}); 
                const data=await callOpenAIChat(messages); 
                const a=data.choices?.[0]?.message?.content||''; 
                messages.push({role:'assistant',content:a}); 
                addMsg('assistant',a);
              } else {
                addMsg('assistant','[–ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è]');
              }
            }catch(e){ 
              console.error('Transcription error:', e);
              addMsg('assistant','[–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: '+e.message+']'); 
            }
          };
          mediaRecorder.start(); 
          isRecording=true; 
          btn.textContent='‚ñ†'; 
          btn.style.background='#dc2626'; 
          btn.style.color='#fff'; 
          btn.title='–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
        }catch(e){ 
          console.error('Microphone access error:', e);
          alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + e.message); 
        }
      } else {
        mediaRecorder?.stop(); 
        isRecording=false; 
        btn.textContent='üé§'; 
        btn.style.background=''; 
        btn.style.color=''; 
        btn.title='–ù–∞–¥–∏–∫—Ç–æ–≤–∞—Ç—å';
      }
    };

    document.getElementById('file-audio').onchange=async(e)=>{ 
      const f=e.target.files?.[0]; 
      if(!f) return; 
      try{
        const tr=await transcribeAudio(f); 
        document.getElementById('raw').value=(tr.text||''); 
      }catch(e){
        alert('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: '+e.message);
      }
      e.target.value=''; 
    };

    // ====== FILTERS ======
    document.getElementById('search').oninput = render;
    document.getElementById('filter-category').onchange = render;
    document.getElementById('filter-time').onchange = render;
    document.getElementById('filter-fav').onchange = render;
  </script>
</body>
</html>
